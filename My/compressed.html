<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Argo v2.3</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
     #maintxtbox,#outputh{padding:20px;top:80%}#outputh,body{background-color:#fcf7ed}#maintxtbox{position:fixed;left:50%;transform:translateX(-50%);border-radius:50px;width:20%;border:1px solid #000;transition:.3s;opacity:.6}#maintxtbox:active,#maintxtbox:focus,#maintxtbox:hover{width:80%;transition:.3s;opacity:1}#textContainer{width:80%;line-height:2;font-family:sans-serif}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0)}100%{-webkit-transform:rotate(360deg)}}#loader,#outputh{position:fixed;transform:translateX(-50%)}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.invis{display:none}.vis{display:block}#loader{border:16px solid #fff;border-radius:50%;border-top:16px solid #8b8b8b;width:120px;height:120px;-webkit-animation:2s linear infinite spin;animation:2s linear infinite spin;left:45%;top:30%}#othertxt{float:left}#outputh{cursor:pointer;left:90%;border-radius:50px;width:10%;border:1px solid #f2d6ff;transition:.2s}#outputh:hover{background-color:#f2d6ff;border:1px solid #000;transition:.2s;padding:22px;width:11%}
    </style>
</head>
<body>
    <div id="loader" class="invis">
    </div>
    <div id="textContainer">
        <div id="othertxt">
        </div>
    </div>
    <input id="maintxtbox" placeholder="Ask Argo Anything" onkeydown="search(this)"></input> 
    <button id ="outputh">Start Voice Recognition</button>
    <script>
const startButton=document.getElementById("outputh"),outputDiv=document.getElementById("othertxt");function moveForward(){fetch("/forward")}function moveLeft(){fetch("/left")}function stopRobot(){fetch("/stop")}function moveRight(){fetch("/right")}function moveReverse(){fetch("/reverse")}function moveUp(){fetch("/up")}function stopArm(){fetch("/stoparm")}function moveDown(){fetch("/down")}function fetchDistanceAuto(){return fetch("/distance").then(e=>e.text()).then(e=>e)}const recognition=new(window.SpeechRecognition||window.webkitSpeechRecognition||window.mozSpeechRecognition||window.msSpeechRecognition);recognition.lang="en-US",recognition.onstart=()=>{startButton.textContent="Listening..."},recognition.onresult=e=>{if(!isResponding&&!isThinking){const t=e.results[0][0].transcript;if(outputDiv.textContent=t,t.toLowerCase().includes("argo")){e=t.toLowerCase().replace("argo","");if(console.log("User voice request: "+e),!isResponding&&!isThinking){window.speechSynthesis.cancel(),socket.emit("request",e),loading();const n=document.getElementById("othertxt"),o=document.createElement("b");o.textContent=document.getElementById("maintxtbox").value,o.style.float="right",n.appendChild(o),document.getElementById("maintxtbox").value=""}}}},recognition.onend=()=>{startButton.textContent="Start Voice Input",startButton.click()},startButton.addEventListener("click",()=>{recognition.start()});var socket=io("http://192.168.68.110:3000");async function search(e){if("Enter"===event.key){window.speechSynthesis.cancel(),loading();var t=await fetchDistanceAuto();socket.emit("request",document.getElementById("maintxtbox").value+"[DISTANCE: "+t.toString());const n=document.getElementById("othertxt"),o=document.createElement("b");o.textContent=document.getElementById("maintxtbox").value,o.style.float="right",n.appendChild(o),document.getElementById("maintxtbox").value=""}}function loading(){document.getElementById("loader").setAttribute("class","vis")}function stopLoading(){document.getElementById("loader").setAttribute("class","invis")}var isThinking=!1,isResponding=!1,responseTxt="",fullTxt="";function extractTextBetweenSubstrings(e,t,n){var o=e.indexOf(t),n=e.indexOf(n);if(-1===o||-1===n)return"";t=o+t.length;return e.substring(t,n)}socket.on("response",function(e){stopLoading(),fullTxt+=e;const t=document.createElement("h2");t.textContent="Thinking: ";const n=document.createElement("h2");n.textContent="Response: ";const o=document.getElementById("othertxt"),i=document.createElement("span");var s;"SYSTEM RESPONSE FINISHED"==e?(responseTxt.includes("{")&&extractMovement(responseTxt),console.log("FULL TXT: "+fullTxt),(s=new SpeechSynthesisUtterance).text=responseTxt,window.speechSynthesis.speak(s),isResponding=isThinking=!1,responseTxt=fullTxt=""):"<think>"==e?(o.appendChild(document.createElement("br")),o.appendChild(t),o.appendChild(document.createElement("br")),isResponding=!(isThinking=!0)):"</think>"==e?(o.appendChild(document.createElement("br")),o.appendChild(n),o.appendChild(document.createElement("br")),isResponding=!(isThinking=!1)):(isThinking||isResponding||(o.appendChild(document.createElement("br")),o.appendChild(t),o.appendChild(document.createElement("br"))),isResponding&&(responseTxt+=e),i.textContent=e,o.appendChild(i),i.scrollIntoView())});async function extractMovement(e){var t,n,o,i=extractTextBetweenSubstrings(e,"{","}").split(",");for(let e=0;e<i.length;e++)i[e].includes("forward")?(console.log("NEW COMMAND RECIEVED! 1"),t=i[e].replace("forward:",""),n=Number(t),o=Math.floor(1e3*n/3.8),console.log(o),moveForward(),await new Promise(e=>setTimeout(e,o)),stopRobot()):i[e].includes("backward")?(console.log("NEW COMMAND RECIEVED! 2"),t=i[e].replace("backward:",""),console.log(t),n=Number(t),o=Math.floor(1e3*n/3.8),console.log(o),moveReverse(),await new Promise(e=>setTimeout(e,o)),stopRobot()):i[e].includes("right")?(console.log("NEW COMMAND RECIEVED! 3"),t=i[e].replace("right:",""),console.log(t),n=Number(t),o=Math.floor(25.5*n),console.log(o),moveRight(),await new Promise(e=>setTimeout(e,o)),stopRobot()):i[e].includes("left")?(console.log("NEW COMMAND RECIEVED! 4"),t=i[e].replace("left:",""),console.log(t),n=Number(t),o=Math.floor(25.5*n),console.log(o),moveLeft(),await new Promise(e=>setTimeout(e,o)),stopRobot()):i[e].includes("up")?(console.log("NEW COMMAND RECIEVED! 5"),t=i[e].replace("up:",""),console.log(t),n=Number(t),o=Math.floor(20*n),console.log(o),moveUp(),await new Promise(e=>setTimeout(e,o)),stopArm()):i[e].includes("down")&&(console.log("NEW COMMAND RECIEVED! 5"),t=i[e].replace("down:",""),console.log(t),n=Number(t),o=Math.floor(20*n),console.log(o),moveDown(),await new Promise(e=>setTimeout(e,o)),stopArm())}
    </script>
</body>
</html>